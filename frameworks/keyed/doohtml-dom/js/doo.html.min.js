/*! For license information please see doo.html.min.js.LICENSE.txt */
(()=>{"use strict";const e="bind",t="{{",a="}}",l="shadow";class i extends HTMLElement{static get version(){return"v0.92.1-beta"}static define(e,t=null){let a=t||e.name.toLowerCase();customElements.define("doo-"+a,e)}constructor(e=12){super(),this.PAGE_SIZE=e,this.data={},this.place=[],this.template=void 0,this.visibleColumns=[],this.dataHasHtml=!1,this.dataHydrate=!1}static get observedAttributes(){return["data-hydrate","data-has-html","data-key","data-template","bind","data-bind","data-page-size","page-size"]}async attributeChangedCallback(e,t,a){a.length>0&&t!==a&&("page-size"===e?this.PAGE_SIZE=a:"data-key"===e?this.dataKey=a:"data-has-html"===e?this.dataHasHtml=a:"data-hydrate"===e?this.dataHydrate=a:"debug"===e&&(Doo.debug=!0))}dooParse(t){let a=t.cloneNode(!0);a.removeAttribute(e),a.removeAttribute("data-key");let l=a.outerHTML.replace(/\t/g,"").replace(/\n/g,""),i=l;["src","selected","checked","disabled","readonly"].forEach((e=>{l=l.replace(new RegExp(" "+e+'="{{(.+)}}"',"g")," doo-"+e+'="{{$1}}"')}));let s=i===l,n=document.createElement("template");n.innerHTML=l;let o=[];const r=(e,t,a)=>{let l=[],i=e;for(;i!==n.firstElementChild;){let e=i.previousSibling,t=0;for(;e;)t++,e=e.previousSibling;i=i.parentNode,i&&l.unshift(t)}o.push([t,l.slice(1),a])},d=document.createTreeWalker(n.content,NodeFilter.SHOW_TEXT,{acceptNode:()=>NodeFilter.FILTER_ACCEPT});let h=d.nextNode(),c=[];for(;h;){let e=h.wholeText.trim();if(0===e.indexOf("{{")&&e.lastIndexOf("}}")===e.length-2);else{let t=e.replace(/{{/g,"<span>{{").replace(/}}/g,"}}</span>");c.push({node:h.parentNode,oldText:e,newText:t})}h=d.nextNode()}for(let e=0,t=c.length;e<t;e++)c[e].node.innerHTML=c[e].node.innerHTML.replace(c[e].oldText,c[e].newText);let p=n.content.cloneNode(!0);const m=document.createTreeWalker(p,NodeFilter.SHOW_TEXT,{acceptNode:()=>NodeFilter.FILTER_ACCEPT});let u=m.nextNode();for(;u;)0===u.textContent.indexOf("{{")&&r(u,u.textContent.replace("{{","").replace("}}",""),"textContent"),u=m.nextNode();const g=document.createTreeWalker(p,NodeFilter.SHOW_ELEMENT,{acceptNode:()=>NodeFilter.FILTER_ACCEPT});for(u=g.nextNode();u;){for(const e of[...u.attributes])e.nodeValue.includes("{{")&&r(u,e.nodeValue.replace("{{","").replace("}}",""),e.name);u=g.nextNode()}let f=p.firstElementChild.outerHTML;return o.forEach((e=>{let t="{{"+e[0]+"}}";f=f.replace(new RegExp(t,"g"),"")})),p.outerHTML=f,{processNode:p.firstElementChild,xHtml:s,dataSlots:o}}initReactiveDataNodes(l){const i=e=>{let t=0;for(;e.parentElement;)e=e.parentElement,t++;return t};this.dataMap=null,this.flex=null,this.hasAttribute("data-map")&&(0===this.getAttribute("data-map").indexOf("Doo.reflect")||(this.dataMap=this.getAttribute("data-map").split("|"))),this.hasAttribute("flex")&&(this.flex=this.getAttribute("flex").replace("[","").replace("]","").split("|"));let s=l.content.querySelectorAll('[data-src="${data-map}"]');s.length>0&&[...s].forEach((e=>{let t=[];this.dataMap.forEach(((e,a)=>{let l=void 0===this.flex[a]?1:this.flex[a],i=e.split(":"),s=i.length>1?i[1]:i[0],n="";l.includes(":")&&(n=l.split(":").length>2?"doo-center":"doo-end",l=l.replace(/:/g,"")),t.push({label:s,fieldName:this.dynamicField(i[0]),flex:l,flexJustify:n})}));let a=this.htmlParse(e,t),l=e.parentElement;l.removeChild(e),l.innerHTML=a+l.innerHTML})),l.innerHTML=l.innerHTML.replace(/\$\{(.+?)\}/gm,((e,i)=>isNaN(i)?this.hasAttribute(i)?this.getAttribute(i):l.hasAttribute(i)?l.getAttribute(i):"":this.dataMap.length>0?t+this.dataMap[i-1]+a:void 0)),[...l.content.querySelectorAll("[bind]")].forEach((e=>{if(!e.hasAttribute("data-src")){let t=this.hasAttribute("doo-dispatch")?"DooX":"this.data";e.setAttribute("data-src",t)}}));let n,o,r=l.content.querySelectorAll("[data-src]"),d=r.length,h=0,c=[];for(h=0;h<d;h++){let t=r[h].getAttribute(e),a=r[h].getAttribute("data-src");a&&(this.setAttribute("doo-dispatch",t),o=a.trim()),0===a.indexOf("this.parent")&&(r[h].useParent=!0),r[h].removeAttribute("data-src"),r[h].level=i(r[h]),c.push(r[h])}for(this.removeAttribute("data-map"),this.removeAttribute("flex"),this.removeAttribute("data-fetch"),c.sort(((e,t)=>e.level===t.level?0:e.level>t.level?1:-1)).reverse(),h=0;h<d;h++){n="|STYLE|LINK|".indexOf(`|${c[h].tagName}|`)>-1?c[h]:c[h].parentElement&&("void"===r[h].getAttribute(e)||"|DL|UL|TBODY|THEAD|TFOOT|TR|SELECT|SECTION|".indexOf(`|${c[h].parentElement.tagName}|`)>-1)?c[h].parentElement:document.createElement("data"),n.dataKey=c[h].getAttribute(e);let t=this.dooParse(c[h],this,this.dataMap);n.processNode=t.processNode,n.xHtml=t.xHtml,n.dataSlots=t.dataSlots,n.name=h,n.level=i(c[h]),n.useParent=c[h].useParent,n.noRepeat=c[h].hasAttribute("data-norepeat"),"DATA"!==n.tagName&&"STYLE"!==n.tagName&&"LINK"!==n.tagName||(c[h].parentElement?c[h].parentElement.replaceChild(n,c[h]):(console.log("Warning: Templates should only have one child node"),c[h].appendChild(n))),this.place.push(n)}return this.place}async setContext(){this.childNodes.length>0&&this.getElementsByTagName("template")&&this.getElementsByTagName("template").length>0&&this.removeChild(this.getElementsByTagName("template").item(0));let e=this.getAttribute("context")||l;if(e===l){this.componentContainer=this.shadow.host,this.showComponentContainer(!1);let e=this.templateElem.firstElementChild.hasAttribute("class")?" "+this.templateElem.firstElementChild.getAttribute("class"):"",t=this.hasAttribute("class")?this.getAttribute("class")+" ":"";t+e!==""&&this.templateElem.firstElementChild&&this.templateElem.firstElementChild.setAttribute("class",`${t}${e}`),this.shadow.appendChild(this.templateElem)}else"document"===e&&(this.componentContainer=this.parentElement,this.showComponentContainer(!1),this.componentContainer.replaceChild(this.templateElem,this));this.render([],this.place[0])}getItemValue(e,t){return e[t]?e[t]:""}renderHTML(e,t,a=0,l=this.PAGE_SIZE){let i,s,n=t.length,o=a+l;o>n&&(o=n);let r=e.dataSlots.length;const d=(e,t,a)=>{let l=t[a];return e.childNodes[l]?d(e.childNodes[l],t,++a):e},h=(a,l)=>{for(let i=0;i<r;i++)s=d(a,e.dataSlots[i][1],0),s?"textContent"===e.dataSlots[i][2]?s.textContent=t[l][e.dataSlots[i][0]]:s.setAttribute(e.dataSlots[i][2],t[l][e.dataSlots[i][0]]):console.info("Field:"+e.dataSlots[i][0]+" does not exist")};if(this.dataHydrate){let l=e.querySelectorAll(e.processNode.tagName);for(let s=a;s<o;s++){let a=l.item(s);i=a||e.processNode,h(i,s),a||(e.appendChild(i.cloneNode(!0)).key=this.getItemValue(t[s],this.dataKey))}}else for(let l=a;l<o;l++)i=e.processNode,h(i,l),e.appendChild(i.cloneNode(!0)).key=this.getItemValue(t[l],this.dataKey)}async showComponentContainer(){this.componentContainer&&(this.componentContainer.style.visibility="visible")}renderTable(e=this.data[this.defaultDataSet],t=this.place[0],a=0){let l=e.length;0!==l?(t.childNodes.length>l&&(t.textContent=""),this.renderHTML(t,e,a,l-a)):t.textContent=""}append(e=this.data[this.defaultDataSet],t=this.place[0],a=0){this.renderHTML(t,e,a,e.length-a,!0)}getIndex(e,t,a=this.data[this.defaultDataSet]){return a.findIndex(((a,l)=>{if(a[t]===e.key)return l}))}render(t=null,a=0,l=null){if(!this.template)return console.error(this.name+" has no template defined"),console.log("You need to set a data-template attribute on the <doo-html /> component"),console.log("You can referense you data-template by a template id"),console.log('Example: <doo-html data-template="#t1" .../>'),console.log("Templates can also be external and you can use reletive path to access it"),void console.log('Example: <doo-html data-template="./templates/t1.html" .../>');this.place||console.log("No target set on the component or inside the template. USAGE: set the data-bind=[your data pointer]");for(let i=0,s=this.place.length;i<s;i++){if("TR"===this.place[i].tagName||"TBODY"===this.place[i].tagName||"TABLE"===this.place[i].tagName){this.renderTable(t,this.place[i],a);continue}if(t&&t!==this.place[i].dataKey)continue;if(0===a&&"STYLE"!==this.place[i].tagName&&!this.place[i].classList.contains("fhead")){let t="dummy"===this.place[i].getAttribute(e)?-1:0;this.place[i].setAttribute("page",t)}let s=this.place[i].dataKey,n=this.place[i].noRepeat?1:this.PAGE_SIZE;null===l?this.renderHTML(this.place[i],s,a*this.PAGE_SIZE,n):this.place[i].append(this.renderHTML(this.place[i],s,l,1))}return a}async connectedCallback(){let e=this.getAttribute("context")||l;this.shadow=e===l?this.attachShadow({mode:"open"}):document,!this.defaultDataSet&&this.getAttribute("bind")&&(this.defaultDataSet=this.getAttribute("bind")),this.scrollTarget&&(this.scrollElem=this.shadow.querySelector(this.scrollTarget)),this.template=this.getAttribute("template"),this.templateNode=await this.createDooTemplate(this.template),this.templateElem=this.templateNode.content,this.initReactiveDataNodes(this.templateNode),this.setContext(),"function"==typeof this.dooAfterRender&&await this.dooAfterRender()}fetchTemplate(e){return new Promise(((t,a)=>{const l=new XMLHttpRequest;l.open("GET",e),l.onload=()=>t(l.responseText),l.onerror=()=>a(l.statusText),l.send()}))}async createDooTemplate(e){let t="";t=0===e.indexOf("#")?document.querySelector(e).outerHTML:await this.fetchTemplate(e);let a=document.createElement("div");a.innerHTML=t,a.querySelector("template")&&(a.innerHTML=a.querySelector("template")?t:`<template><center><pre>The template you are trying to import does not have a &lt;template&gt tag</pre><div style="color:red">${this.template}</div></enter></template>`);let l=a.querySelector("template").cloneNode(!0);l.removeAttribute("id");let i=document.createElement("template");i.innerHTML=l.innerHTML;let s=i.content,n=s.querySelectorAll("style");return n&&n.length>0&&s.appendChild(n[0]),i}}window.DooHTML||(window.Doo=i,window.DooHTML=i),i.define(i,"html")})();
